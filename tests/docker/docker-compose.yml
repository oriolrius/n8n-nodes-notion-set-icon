services:
  # Main n8n service with custom node
  n8n:
    image: n8nio/n8n:latest
    container_name: n8n-notion-test
    ports:
      - "15678:5678"
    environment:
      - N8N_BASIC_AUTH_ACTIVE=false
      - N8N_HOST=0.0.0.0
      - N8N_PORT=5678
      - N8N_PROTOCOL=http
      - N8N_SECURE_COOKIE=false
      - N8N_EXECUTIONS_PROCESS=main
      - N8N_METRICS=true
      - N8N_LOG_LEVEL=debug
      - N8N_USER_FOLDER=/home/node/.n8n
      - NODE_ENV=development
      - N8N_CUSTOM_EXTENSIONS=/home/node/.n8n/custom
      # Notion credentials from .env
      - NOTION_TOKEN_V2=${NOTION_TOKEN_V2}
      - SPACE_ID=${SPACE_ID}
      - NOTION_USER_ID=${NOTION_USER_ID}
    volumes:
      # Mount the entire built package as a custom node
      - ./custom-node:/home/node/.n8n/custom
      # Mount examples
      - ../../examples:/home/node/workflows:ro
      # Mount validation scripts
      - ./validation:/home/node/validation:ro
      # Persist n8n data
      - n8n-data:/home/node/.n8n/database
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:5678/healthz"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - n8n-test-network

  # Validation service
  validator:
    build:
      context: .
      dockerfile: Dockerfile.validator
    container_name: n8n-validator
    depends_on:
      n8n:
        condition: service_healthy
    environment:
      - N8N_URL=http://n8n:5678
      - EXPECTED_NODE_NAME=n8n-nodes-notion-set-icon.notionSetIcon
      - EXPECTED_NODE_VERSION=1.0.4
    volumes:
      - ./validation:/app:ro
      - ./test-results:/test-results
      - ../../examples:/workflows:ro
      - ../../package.json:/node-package.json:ro
    command: ["node", "/app/validate.js"]
    networks:
      - n8n-test-network

networks:
  n8n-test-network:
    driver: bridge

volumes:
  n8n-data: